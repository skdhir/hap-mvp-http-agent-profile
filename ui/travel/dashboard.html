<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Website Owner Dashboard – Travel Flights API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- If styles.css is dark-themed, it's okay; we override a lot with inline styles on body/cards -->
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body
    style="
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
        sans-serif;
      background-color: #f9fafb;
      color: #111827;
    "
  >
    <!-- Page header -->
    <header
      style="
        padding: 16px 24px;
        border-bottom: 1px solid #e5e7eb;
        background-color: #ffffff;
      "
    >
      <h1 style="margin: 0; font-size: 22px; font-weight: 600">
        Website Owner Dashboard – Travel Flights API
      </h1>
      <p style="margin: 6px 0 0; color: #4b5563; font-size: 14px; max-width: 800px">
        You’re viewing traffic and revenue for the site
        <code>travel.sanatdhir.com</code> behind the HAP gateway. Humans are
        treated as normal users, unknowns are blocked or limited, and agents are
        billed per call via Stripe (test mode).
      </p>
      <p style="margin: 4px 0 0; color: #6b7280; font-size: 12px; max-width: 800px">
        In the full product, a site owner would sign in, manage multiple websites
        (travel, shopping, news), and drill down per site to see how many verified
        agents, bots, and humans are accessing them, plus per‑agent event history.
        This dashboard shows the Travel Flights API as one example site.
      </p>
    </header>

    <!-- Main content wrapper -->
    <main style="padding: 24px">
      <div
        style="
          max-width: 1100px;
          margin: 0 auto;
        "
      >
        <!-- Top row: traffic & revenue summary cards -->
        <section
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
          "
        >
          <!-- Human total -->
          <div
            style="
              background-color: #ffffff;
              border-radius: 8px;
              border: 1px solid #e5e7eb;
              padding: 16px;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            "
          >
            <div style="font-size: 12px; color: #6b7280">Total human requests</div>
            <div
              id="total-human"
              style="margin-top: 4px; font-size: 24px; font-weight: 600"
            >
              –
            </div>
          </div>

          <!-- Agent total -->
          <div
            style="
              background-color: #ffffff;
              border-radius: 8px;
              border: 1px solid #e5e7eb;
              padding: 16px;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            "
          >
            <div style="font-size: 12px; color: #6b7280">Total agent requests</div>
            <div
              id="total-agent"
              style="margin-top: 4px; font-size: 24px; font-weight: 600"
            >
              –
            </div>
          </div>

          <!-- Unknown/bot total -->
          <div
            style="
              background-color: #ffffff;
              border-radius: 8px;
              border: 1px solid #e5e7eb;
              padding: 16px;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            "
          >
            <div style="font-size: 12px; color: #6b7280">
              Total unknown / bot requests
            </div>
            <div
              id="total-unknown"
              style="margin-top: 4px; font-size: 24px; font-weight: 600"
            >
              –
            </div>
          </div>

          <!-- Revenue card -->
          <div
            style="
              background-color: #ffffff;
              border-radius: 8px;
              border: 1px solid #e5e7eb;
              padding: 16px;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            "
          >
            <div style="font-size: 12px; color: #6b7280">Agent revenue (demo)</div>
            <div
              id="total-revenue"
              style="margin-top: 4px; font-size: 24px; font-weight: 600"
            >
              –
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-top: 4px">
              Based on successful Stripe sessions. Each session is 100 credits =
              $1.00.
            </div>
          </div>
        </section>

        <!-- Daily traffic table -->
        <section
          style="
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
          "
        >
          <div
            style="
              display: flex;
              align-items: baseline;
              justify-content: space-between;
              margin-bottom: 8px;
            "
          >
            <h2 style="margin: 0; font-size: 16px">Daily traffic</h2>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button
                type="button"
                onclick="loadStats()"
                style="
                  padding: 4px 8px;
                  font-size: 12px;
                  border-radius: 4px;
                  border: 1px solid #d1d5db;
                  background-color: #ffffff;
                  cursor: pointer;
                "
              >
                Refresh
              </button>
              <span
                id="stats-status"
                style="font-size: 12px; color: #6b7280"
              ></span>
            </div>
          </div>

          <p style="margin: 4px 0 12px; font-size: 13px; color: #4b5563">
            HAP classifies each request as <strong>human</strong>,
            <strong>agent</strong>, or <strong>unknown</strong>. This table shows
            the counts per day.
          </p>
          <div style="overflow-x: auto">
            <table
              style="
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
                border: 1px solid #e5e7eb;
              "
            >
              <thead>
                <tr style="background-color: #f9fafb">
                  <th
                    style="
                      text-align: left;
                      padding: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    "
                  >
                    Day
                  </th>
                  <th
                    style="
                      text-align: right;
                      padding: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    "
                  >
                    Humans
                  </th>
                  <th
                    style="
                      text-align: right;
                      padding: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    "
                  >
                    Agents
                  </th>
                  <th
                    style="
                      text-align: right;
                      padding: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    "
                  >
                    Unknown / bots
                  </th>
                </tr>
              </thead>
              <tbody id="daily-rows">
                <tr>
                  <td
                    colspan="4"
                    style="padding: 8px; text-align: center; color: #6b7280"
                  >
                    Loading…
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Agent wallets & payments -->
        <section
          style="
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
          "
        >
          <div
            style="
              display: flex;
              align-items: baseline;
              justify-content: space-between;
              margin-bottom: 8px;
            "
          >
            <h2 style="margin: 0; font-size: 16px">Agent wallets & payments</h2>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button
                type="button"
                onclick="loadBilling()"
                style="
                  padding: 4px 8px;
                  font-size: 12px;
                  border-radius: 4px;
                  border: 1px solid #d1d5db;
                  background-color: #ffffff;
                  cursor: pointer;
                "
              >
                Refresh
              </button>
              <span
                id="billing-status"
                style="font-size: 12px; color: #6b7280"
              ></span>
            </div>
          </div>

          <p style="margin: 4px 0 12px; font-size: 13px; color: #4b5563">
            Each verified agent has a wallet of credits. Stripe top‑ups (manual or
            autopay) increase credits; each API call decrements credits based on the
            site’s pricing rules.
          </p>

            <!-- Payments & pricing info (demo) -->
          <div
            style="
              margin-bottom: 12px;
              padding: 10px;
              border-radius: 6px;
              background-color: #f3f4f6;
              border: 1px solid #e5e7eb;
              font-size: 13px;
            "
          >
            <div style="font-weight: 600; margin-bottom: 4px;">
              Payments & pricing (demo – Travel Flights API)
            </div>
            <ul style="margin: 0; padding-left: 16px;">
              <li>
                <strong>Provider:</strong> Stripe (test mode).
              </li>
              <li>
                <strong>Who gets paid:</strong> the owner of
                <code>travel.sanatdhir.com</code> (this API).
              </li>
              <li>
                <strong>Pricing:</strong> 1 credit per flight search, 100 credits = $1.00.
              </li>
              <li>
                When a verified agent runs out of credits, the HAP gateway creates a
                Stripe payment and credits that agent’s wallet. Each successful
                session here corresponds to a top‑up.
              </li>
            </ul>
          </div>

          <!-- Payment sessions summary -->
          <div
            style="
              display: flex;
              flex-wrap: wrap;
              gap: 12px;
              font-size: 13px;
              margin-bottom: 16px;
            "
          >
            <div>
              <strong>Total payment sessions: </strong>
              <span id="total-sessions">–</span>
            </div>
            <div>
              <strong>Succeeded: </strong>
              <span id="sessions-succeeded">–</span>
            </div>
            <div>
              <strong>Pending: </strong>
              <span id="sessions-pending">–</span>
            </div>
            <div>
              <strong>Failed / other: </strong>
              <span id="sessions-other">–</span>
            </div>
            <div>
              <strong>Total credits sold (approx): </strong>
              <span id="total-credits-sold">–</span>
            </div>
          </div>

          <!-- Agent wallets table -->
          <div style="overflow-x: auto">
            <table
              style="
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
                border: 1px solid #e5e7eb;
              "
            >
              <thead>
                <tr style="background-color: #f9fafb">
                  <th
                    style="
                      text-align: left;
                      padding: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    "
                  >
                    Agent ID
                  </th>
                  <th
                    style="
                      text-align: right;
                      padding: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    "
                  >
                    Credits
                  </th>
                  <th
                    style="
                      text-align: left;
                      padding: 8px;
                      border-bottom: 1px solid #e5e7eb;
                    "
                  >
                    Last updated
                  </th>
                </tr>
              </thead>
              <tbody id="wallet-rows">
                <tr>
                  <td
                    colspan="3"
                    style="padding: 8px; text-align: center; color: #6b7280"
                  >
                    Loading…
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <!-- Inline JS to load data from your existing APIs -->
    <script>
      const API_BASE = "https://api.sanatdhir.com";

      function $(id) {
        return document.getElementById(id);
      }

      async function loadStats() {
        const statusEl = $("stats-status");
        statusEl.textContent = "Loading…";
        const tbody = $("daily-rows");
        tbody.innerHTML =
          '<tr><td colspan="4" style="padding: 8px; text-align: center; color: #6b7280">Loading…</td></tr>';

        try {
          const resp = await fetch(API_BASE + "/api/stats/summary");
          const data = await resp.json();

          if (data.status !== "ok") {
            statusEl.textContent = "Error loading stats";
            return;
          }

          const counts = data.counts || { human: 0, agent: 0, unknown: 0 };

          $("total-human").textContent = counts.human ?? 0;
          $("total-agent").textContent = counts.agent ?? 0;
          $("total-unknown").textContent = counts.unknown ?? 0;

          if (!data.days || data.days.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="padding: 8px; text-align: center; color: #6b7280">No traffic yet.</td></tr>';
          } else {
            tbody.innerHTML = "";
            data.days.forEach((d) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${d.day}</td>
                <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">${
                  d.counts?.human ?? 0
                }</td>
                <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">${
                  d.counts?.agent ?? 0
                }</td>
                <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">${
                  d.counts?.unknown ?? 0
                }</td>
              `;
              tbody.appendChild(tr);
            });
          }

          statusEl.textContent = `Loaded ${data.total_days ?? 0} day(s) of stats.`;
        } catch (err) {
          console.error("Error loading stats:", err);
          statusEl.textContent = "Error loading stats";
          $("total-human").textContent = "–";
          $("total-agent").textContent = "–";
          $("total-unknown").textContent = "–";
        }
      }

      async function loadBilling() {
        const statusEl = $("billing-status");
        statusEl.textContent = "Loading…";
        const tbody = $("wallet-rows");
        tbody.innerHTML =
          '<tr><td colspan="3" style="padding: 8px; text-align: center; color: #6b7280">Loading…</td></tr>';

        try {
          const resp = await fetch(API_BASE + "/api/billing/agents");
          const data = await resp.json();

          if (data.status !== "ok") {
            statusEl.textContent = "Error loading billing";
            return;
          }

          const wallets = data.wallets || [];
          const sessions = data.paymentSessions || { total: 0, byStatus: {} };
          const byStatus = sessions.byStatus || {};

          const totalSessions = sessions.total ?? 0;
          const succeeded = byStatus["succeeded"] ?? 0;
          const pending = byStatus["pending"] ?? 0;
          const other =
            totalSessions - succeeded - pending > 0
              ? totalSessions - succeeded - pending
              : 0;

          $("total-sessions").textContent = totalSessions;
          $("sessions-succeeded").textContent = succeeded;
          $("sessions-pending").textContent = pending;
          $("sessions-other").textContent = other;

          // Demo assumption: each successful session = 100 credits, $1
          const CREDITS_PER_SESSION = 100;
          const totalCreditsSold = succeeded * CREDITS_PER_SESSION;
          $("total-credits-sold").textContent = totalCreditsSold;

          const totalRevenue = succeeded * 1.0; // $1 per session (demo)
          $("total-revenue").textContent = `$${totalRevenue.toFixed(2)}`;

          if (!wallets.length) {
            tbody.innerHTML =
              '<tr><td colspan="3" style="padding: 8px; text-align: center; color: #6b7280">No wallets yet.</td></tr>';
          } else {
            // Sort by agentId for stable display
            wallets.sort((a, b) =>
              (a.agentId || "").localeCompare(b.agentId || "")
            );
            tbody.innerHTML = "";
            wallets.forEach((w) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-family: monospace; font-size: 12px;">${
                  w.agentId || "-"
                }</td>
                <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">${
                  w.credits ?? 0
                }</td>
                <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${
                  w.updatedAt || "-"
                }</td>
              `;
              tbody.appendChild(tr);
            });
          }

          statusEl.textContent = `Loaded ${wallets.length} wallet(s) and ${totalSessions} payment session(s).`;
        } catch (err) {
          console.error("Error loading billing:", err);
          statusEl.textContent = "Error loading billing";
          $("total-sessions").textContent = "–";
          $("sessions-succeeded").textContent = "–";
          $("sessions-pending").textContent = "–";
          $("sessions-other").textContent = "–";
          $("total-credits-sold").textContent = "–";
          $("total-revenue").textContent = "–";
        }
      }

      // Kick off loads on page ready
      window.addEventListener("DOMContentLoaded", () => {
        loadStats();
        loadBilling();
      });
    </script>
  </body>
</html>
